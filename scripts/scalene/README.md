# FastAPI é¡¹ç›®æ•´åˆ Scalene æ€§èƒ½åˆ†æå·¥å…·å®Œæ•´æŒ‡å—

> **é‡è¦æç¤º**ï¼šæœ¬æ–‡æ¡£ä¸­æ‰€æœ‰æ–‡ä»¶å‡ä½äº `scripts/scalene/` ç›®å½•ä¸‹ã€‚

> **Scalene ç‰ˆæœ¬è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŸºäº **Scalene 2.0+** ç‰ˆæœ¬ç¼–å†™ï¼Œä½¿ç”¨æ–°çš„ `run` å’Œ `view` å‘½ä»¤ç»“æ„ã€‚

> **Windows å…¼å®¹æ€§è­¦å‘Š**ï¼šâš ï¸ Scalene ç›®å‰ä»…æ”¯æŒ Mac å’Œ Unix å¹³å°çš„ `multiprocessing` åº“ï¼Œ**æ— æ³•åœ¨ Windows ç¯å¢ƒä¸­è¿è¡Œ**ã€‚Windows ç”¨æˆ·è¯·ä½¿ç”¨ WSL æˆ–æ›¿ä»£å·¥å…·ï¼ˆpy-spyã€cProfileï¼‰ã€‚

## ç›®å½•

1. [ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è§£æ€§èƒ½åˆ†æ](#ç¬¬ä¸€éƒ¨åˆ†ç†è§£æ€§èƒ½åˆ†æ)
2. [ç¬¬äºŒéƒ¨åˆ†ï¼šè®¤è¯† Scalene](#ç¬¬äºŒéƒ¨åˆ†è®¤è¯†-scalene)
3. [ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®‰è£… Scalene](#ç¬¬ä¸‰éƒ¨åˆ†å®‰è£…-scalene)
4. [ç¬¬å››éƒ¨åˆ†ï¼šé¡¹ç›®æ–‡ä»¶ç»“æ„](#ç¬¬å››éƒ¨åˆ†é¡¹ç›®æ–‡ä»¶ç»“æ„)
5. [ç¬¬äº”éƒ¨åˆ†ï¼šè¿è¡Œæ€§èƒ½åˆ†æ](#ç¬¬äº”éƒ¨åˆ†è¿è¡Œæ€§èƒ½åˆ†æ)
6. [ç¬¬å…­éƒ¨åˆ†ï¼šè§£è¯»åˆ†æç»“æœ](#ç¬¬å…­éƒ¨åˆ†è§£è¯»åˆ†æç»“æœ)
7. [ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®é™…ä½¿ç”¨æ¡ˆä¾‹](#ç¬¬ä¸ƒéƒ¨åˆ†å®é™…ä½¿ç”¨æ¡ˆä¾‹)
8. [ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜](#ç¬¬å…«éƒ¨åˆ†å¸¸è§é—®é¢˜)

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è§£æ€§èƒ½åˆ†æ

## 1.1 ä»€ä¹ˆæ˜¯æ€§èƒ½åˆ†æï¼Ÿ

**æ€§èƒ½åˆ†æï¼ˆProfilingï¼‰** å°±æ˜¯ç»™ç¨‹åºåš"ä½“æ£€"ï¼š
- æµ‹é‡ç¨‹åºå„éƒ¨åˆ†çš„æ‰§è¡Œæ—¶é—´
- æ‰¾å‡ºæœ€æ…¢çš„éƒ¨åˆ†ï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰
- å‘Šè¯‰ä½ åº”è¯¥ä¼˜åŒ–å“ªé‡Œ

## 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½åˆ†æï¼Ÿ

### å¼€å‘ä¸­çš„å¸¸è§é—®é¢˜

```
âŒ ç¨‹åºè¿è¡Œå¾ˆæ…¢ï¼Œä½†ä¸çŸ¥é“åŸå› 
âŒ ä¼˜åŒ–äº†å¾ˆå¤šåœ°æ–¹ï¼Œä½†é€Ÿåº¦æ²¡æå‡
âŒ ä¸çŸ¥é“è¯¥ä¼˜åŒ–å“ªéƒ¨åˆ†ä»£ç 
```

**æ€§èƒ½åˆ†æå¸®ä½ å›ç­”ï¼š**
- æˆ‘çš„ç¨‹åºå“ªé‡Œæœ€æ…¢ï¼Ÿï¼ˆæ—¶é—´éƒ½èŠ±åœ¨å“ªäº†ï¼‰
- æˆ‘çš„ç¨‹åºç”¨äº†å¤šå°‘å†…å­˜ï¼Ÿï¼ˆå†…å­˜å¢é•¿æ­£å¸¸å—ï¼‰
- ä¼˜åŒ–å“ªé‡Œæ•ˆæœæœ€æ˜æ˜¾ï¼Ÿï¼ˆæŠ•èµ„å›æŠ¥ç‡æœ€é«˜ï¼‰

## 1.3 æ€§èƒ½åˆ†æçš„åŸºæœ¬æ¦‚å¿µ

### 1.3.1 CPU åˆ†æï¼ˆæ—¶é—´åˆ†æï¼‰

**é—®é¢˜**ï¼šç¨‹åºè¿è¡Œæ—¶ï¼ŒCPU æ—¶é—´èŠ±åœ¨å“ªé‡Œï¼Ÿ

**åŸç†**ï¼šå®šæ—¶é‡‡æ ·ï¼Œè®°å½•æ¯ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ CPU åœ¨åšä»€ä¹ˆ

```
é‡‡æ ·ç‚¹ 1: æ­£åœ¨æ‰§è¡Œ login() å‡½æ•°
é‡‡æ ·ç‚¹ 2: æ­£åœ¨æ‰§è¡Œ get_user_data() å‡½æ•°  
é‡‡æ ·ç‚¹ 3: æ­£åœ¨æ‰§è¡Œ database.query() å‡½æ•°
é‡‡æ ·ç‚¹ 4: æ­£åœ¨æ‰§è¡Œ login() å‡½æ•°
...
```

å¦‚æœ 100 æ¬¡é‡‡æ ·ä¸­ï¼Œ40 æ¬¡éƒ½åœ¨ `login()` å‡½æ•°é‡Œï¼Œè¯´æ˜ **40% çš„ CPU æ—¶é—´èŠ±åœ¨ç™»å½•åŠŸèƒ½**ã€‚

### 1.3.2 å†…å­˜åˆ†æï¼ˆç©ºé—´åˆ†æï¼‰

**é—®é¢˜**ï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œå†…å­˜æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Ÿ

**åŸç†**ï¼šè¿½è¸ªæ¯æ¬¡å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œæ‰¾å‡ºå†…å­˜æ³„æ¼

```
åˆ†é…: user_data = {"name": "å¼ ä¸‰"}  # +200 bytes
åˆ†é…: cache = []                   # +64 bytes  
é‡Šæ”¾: del user_data                # -200 bytes
åˆ†é…: big_list = [1,2,3...]        # +10000 bytes
...
```

## 1.4 æ€§èƒ½åˆ†æçš„ä¸¤ä¸ªé˜¶æ®µ

### é˜¶æ®µä¸€ï¼šå‘ç°ç“¶é¢ˆï¼ˆå®šä½é—®é¢˜ï¼‰

```
è¿è¡Œç¨‹åº â†’ æ”¶é›†æ•°æ® â†’ å‘ç°æ…¢çš„å‡½æ•° â†’ é‡ç‚¹ä¼˜åŒ–
```

### é˜¶æ®µäºŒï¼šéªŒè¯ä¼˜åŒ–ï¼ˆç¡®è®¤æ•ˆæœï¼‰

```
ä¼˜åŒ–å‰è¿è¡Œ â†’ è®°å½•æŒ‡æ ‡
ä¼˜åŒ–åè¿è¡Œ â†’ è®°å½•æŒ‡æ ‡
å¯¹æ¯”å·®å¼‚ â†’ ç¡®è®¤ä¼˜åŒ–æ•ˆæœ
```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šè®¤è¯† Scalene

## 2.1 Scalene æ˜¯ä»€ä¹ˆï¼Ÿ

**Scalene** æ˜¯ Python ç”Ÿæ€ä¸­çš„ä¸€ä¸ªé«˜æ€§èƒ½åˆ†æå·¥å…·ï¼Œä¸“é—¨ç”¨æ¥åˆ†æ Python ç¨‹åºçš„æ€§èƒ½é—®é¢˜ã€‚ç”±éº»çœå¤§å­¦å®‰å§†æ–¯ç‰¹åˆ†æ ¡å¼€å‘ç»´æŠ¤ã€‚

### 2.1.1 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½          | è¯´æ˜                            |
| ------------- | ------------------------------- |
| CPU åˆ†æ      | æ‰¾å‡º CPU æ—¶é—´èŠ±åœ¨å“ªé‡Œ           |
| å†…å­˜åˆ†æ      | è¿½è¸ªå†…å­˜ä½¿ç”¨å’Œæ³„æ¼              |
| GPU åˆ†æ      | è¿½è¸ª GPU èµ„æºä½¿ç”¨ï¼ˆå¯é€‰ï¼‰       |
| åŒºåˆ† Python/C | åŒºåˆ† Python ä»£ç å’Œç¬¬ä¸‰æ–¹ C æ‰©å±• |
| AI ä¼˜åŒ–å»ºè®®   | é›†æˆ AI è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®        |
| ä½å¼€é”€        | å¯¹ç¨‹åºè¿è¡Œå½±å“å°                |

### 2.1.2 Scalene vs å…¶ä»–å·¥å…·å¯¹æ¯”

| å·¥å…·          | ç±»å‹     | ä¼˜ç‚¹                      | ç¼ºç‚¹                     | é€‚ç”¨åœºæ™¯   |
| ------------- | -------- | ------------------------- | ------------------------ | ---------- |
| **Scalene**   | é‡‡æ ·åˆ†æ | åŠŸèƒ½å…¨é¢ï¼Œå¼€é”€å°ï¼ŒAI å»ºè®® | èµ„æºå ç”¨ç¨é«˜             | é€šç”¨åœºæ™¯   |
| cProfile      | ç»Ÿè®¡æ‘˜è¦ | æ ‡å‡†åº“å†…ç½®ï¼Œå‡†ç¡®          | åªçœ‹æ€»æ—¶é—´ï¼Œçœ‹ä¸åˆ°è°ƒç”¨é“¾ | å¿«é€Ÿå®šä½   |
| line_profiler | è¡Œçº§åˆ†æ | ç²¾ç¡®åˆ°æ¯ä¸€è¡Œ              | åªèƒ½çœ‹ CPUï¼Œå¼€é”€å¤§       | ç»†ç²’åº¦ä¼˜åŒ– |
| py-spy        | é‡‡æ ·åˆ†æ | å¯é™„åŠ åˆ°è¿è¡Œä¸­è¿›ç¨‹        | åŠŸèƒ½è¾ƒå•ä¸€               | ç”Ÿäº§ç¯å¢ƒ   |

### 2.1.3 ä¸ºä»€ä¹ˆé€‰æ‹© Scaleneï¼Ÿ

```
âœ… ä¸€æ¬¡åˆ†æï¼ŒåŒæ—¶è·å¾— CPU å’Œå†…å­˜ä¿¡æ¯
âœ… å¼€æºå…è´¹ï¼Œç¤¾åŒºæ´»è·ƒ
âœ… ç”Ÿæˆäº¤äº’å¼ HTML æŠ¥å‘Š
âœ… é›†æˆ AI ä¼˜åŒ–å»ºè®®åŠŸèƒ½
âœ… å¯¹ç¨‹åºè¿è¡Œå½±å“å°ï¼ˆå¯æ§åˆ¶ï¼‰
âœ… æ”¯æŒ VS Code æ‰©å±•
```

### 2.1.4 Scalene 2.0 æ–°ç‰¹æ€§

Scalene 2.0 å¼•å…¥äº†æ–°çš„å‘½ä»¤ç»“æ„ï¼š
- **`run` å‘½ä»¤**ï¼šåˆ†æç¨‹åºï¼Œç”Ÿæˆ JSON åŸå§‹æ•°æ®
- **`view` å‘½ä»¤**ï¼šæŸ¥çœ‹åˆ†æç»“æœï¼Œæ”¯æŒæµè§ˆå™¨å’Œ CLI ä¸¤ç§æ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Scalene 2.0 å·¥ä½œæµç¨‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   1. ä½¿ç”¨ `run` å‘½ä»¤åˆ†æç¨‹åº                                â”‚
â”‚      â””â”€ ç”Ÿæˆ JSON æ ¼å¼çš„åŸå§‹æ•°æ®                            â”‚
â”‚                                                             â”‚
â”‚   2. ä½¿ç”¨ `view` å‘½ä»¤æŸ¥çœ‹ç»“æœ                               â”‚
â”‚      â”œâ”€ `view` â†’ æµè§ˆå™¨ä¸­äº¤äº’å¼æŸ¥çœ‹                        â”‚
â”‚      â”œâ”€ `view --html` â†’ ç”Ÿæˆ HTML æŠ¥å‘Š                     â”‚
â”‚      â””â”€ `view --cli` â†’ ç»ˆç«¯è¾“å‡º                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®‰è£… Scalene

## 3.1 å®‰è£…å‘½ä»¤

```bash
pip install -U scalene
```

æˆ–ä½¿ç”¨ uvï¼š

```bash
uv pip install -U scalene
```

## 3.2 éªŒè¯å®‰è£…

```bash
scalene --version
```

å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·ï¼ˆå¦‚ `scalene 2.0.x`ï¼‰ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚

## 3.3 å‘½ä»¤è¡Œç»“æ„

Scalene 2.0 ä½¿ç”¨åŠ¨è¯å‘½ä»¤ç»“æ„ï¼š

```bash
# æŸ¥çœ‹å¸®åŠ©
scalene --help

# åˆ†æç¨‹åº
scalene run your_program.py

# æŸ¥çœ‹åˆ†æç»“æœ
scalene view
scalene view --cli
scalene view --html
```

---

# ç¬¬å››éƒ¨åˆ†ï¼šé¡¹ç›®æ–‡ä»¶ç»“æ„

## 4.1 æ–‡ä»¶ä½ç½®

æ‰€æœ‰ Scalene ç›¸å…³æ–‡ä»¶å‡ä½äºä»¥ä¸‹ç›®å½•ï¼š

```
E:\GitSource\py_fastapi_template\
â””â”€â”€ scripts\
    â””â”€â”€ scalene\
        â”œâ”€â”€ profile_api.py           # åŸºç¡€æ€§èƒ½åˆ†æè„šæœ¬
        â”œâ”€â”€ profile_api_advanced.py  # é«˜çº§æ€§èƒ½åˆ†æè„šæœ¬
        â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## 4.2 æ–‡ä»¶è¯´æ˜

### 4.2.1 profile_api.py - åŸºç¡€åˆ†æè„šæœ¬

**ä½œç”¨**ï¼šä½œä¸ºç¨‹åºå…¥å£ç‚¹ï¼Œè¢« Scalene åˆ†æå™¨è°ƒç”¨ï¼Œå¯åŠ¨ FastAPI æœåŠ¡ã€‚

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# å…ˆè¿è¡Œåˆ†æï¼ˆç”Ÿæˆ JSONï¼‰
scalene run --outfile profile_report.json profile_api.py

# å†ç”Ÿæˆ HTML æŠ¥å‘Š
scalene view --html profile_report.json

# æˆ–è€…ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
scalene view profile_report.json
```

**ä½¿ç”¨ uv è¿è¡Œ**ï¼š

```bash
# è¿è¡Œåˆ†æ
uv run -m scalene run --outfile profile_report.json profile_api.py

# ç”Ÿæˆ HTML æŠ¥å‘Š
uv run -m scalene view --html profile_report.json
```

**æ”¯æŒå‚æ•°**ï¼š

| å‚æ•°      | è¯´æ˜           | é»˜è®¤å€¼  |
| --------- | -------------- | ------- |
| --host    | æœåŠ¡ç»‘å®šçš„åœ°å€ | 0.0.0.0 |
| --port    | æœåŠ¡ç«¯å£å·     | 8000    |
| --workers | å·¥ä½œè¿›ç¨‹æ•°     | 1       |
| --reload  | æ˜¯å¦å¯ç”¨çƒ­é‡è½½ | False   |

### 4.2.2 profile_api_advanced.py - é«˜çº§åˆ†æè„šæœ¬

**ä½œç”¨**ï¼šæä¾›æ›´ç²¾ç»†çš„æ§åˆ¶ï¼ŒåŒ…æ‹¬é‡‡æ ·é—´éš”ã€å­è¿›ç¨‹åˆ†æç­‰ã€‚

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# é«˜ç²¾åº¦é‡‡æ ·
uv run -m scalene run --cpu-sampling-rate 0.0001 --outfile profile.json profile_api_advanced.py

# åˆ†æå­è¿›ç¨‹
uv run -m scalene run --profile-children --outfile profile.json profile_api_advanced.py

# åªåˆ†æç‰¹å®šæ¨¡å—
uv run -m scalene run --profile-only "app.api" --outfile profile.json profile_api_advanced.py
```

**æ”¯æŒå‚æ•°**ï¼š

| å‚æ•°               | è¯´æ˜           | é»˜è®¤å€¼  |
| ------------------ | -------------- | ------- |
| --host             | æœåŠ¡ç»‘å®šçš„åœ°å€ | 0.0.0.0 |
| --port             | æœåŠ¡ç«¯å£å·     | 8000    |
| --sample-interval  | é‡‡æ ·é—´éš”ï¼ˆç§’ï¼‰ | 0.001   |
| --profile-children | æ˜¯å¦åˆ†æå­è¿›ç¨‹ | False   |

## 4.2 Scalene å‘½ä»¤è¡Œé€‰é¡¹

### 4.2.1 `run` å‘½ä»¤é€‰é¡¹

| é€‰é¡¹                | è¯´æ˜               | ç¤ºä¾‹                                              |
| ------------------- | ------------------ | ------------------------------------------------- |
| --outfile           | æŒ‡å®šè¾“å‡º JSON æ–‡ä»¶ | `scalene run --outfile report.json script.py`     |
| --cpu-only          | åªåˆ†æ CPU         | `scalene run --cpu-only script.py`                |
| --memory            | å¯ç”¨å†…å­˜åˆ†æ       | `scalene run --memory script.py`                  |
| --gpu               | å¯ç”¨ GPU åˆ†æ      | `scalene run --gpu script.py`                     |
| --cpu-sampling-rate | è®¾ç½®é‡‡æ ·é—´éš”       | `scalene run --cpu-sampling-rate 0.001 script.py` |
| --profile-children  | åˆ†æå­è¿›ç¨‹         | `scalene run --profile-children script.py`        |
| --profile-only      | åªåˆ†æåŒ¹é…æ¨¡å—     | `scalene run --profile-only "app.api" script.py`  |
| --profile-exclude   | æ’é™¤åŒ¹é…æ¨¡å—       | `scalene run --profile-exclude "tests" script.py` |
| --profile-all       | åˆ†ææ‰€æœ‰ä»£ç        | `scalene run --profile-all script.py`             |
| --use-virtual-time  | åªæµ‹é‡ CPU æ—¶é—´    | `scalene run --use-virtual-time script.py`        |
| --help              | æŸ¥çœ‹å¸®åŠ©           | `scalene run --help`                              |
| --help-advanced     | æŸ¥çœ‹é«˜çº§é€‰é¡¹       | `scalene run --help-advanced`                     |

### 4.3.2 `view` å‘½ä»¤é€‰é¡¹

| é€‰é¡¹   | è¯´æ˜           | ç¤ºä¾‹                              |
| ------ | -------------- | --------------------------------- |
| --cli  | åœ¨ç»ˆç«¯æ˜¾ç¤º     | `scalene view --cli report.json`  |
| --html | ç”Ÿæˆ HTML æŠ¥å‘Š | `scalene view --html report.json` |
| --help | æŸ¥çœ‹å¸®åŠ©       | `scalene view --help`             |

### 4.3.3 é‡‡æ ·é—´éš”è¯´æ˜

| å€¼     | æ•ˆæœ                    | é€‚ç”¨åœºæ™¯ |
| ------ | ----------------------- | -------- |
| 0.1    | ç²—ç³™ï¼ˆ10æ¬¡/ç§’ï¼‰ï¼Œå¼€é”€å° | å¿«é€Ÿæ£€æŸ¥ |
| 0.01   | æ ‡å‡†ï¼ˆ100æ¬¡/ç§’ï¼‰        | ä¸€èˆ¬åˆ†æ |
| 0.001  | ç²¾ç»†ï¼ˆ1000æ¬¡/ç§’ï¼‰       | ç²¾ç¡®åˆ†æ |
| 0.0001 | éå¸¸ç²¾ç»†ï¼ˆ10000æ¬¡/ç§’ï¼‰  | æ·±åº¦åˆ†æ |

```
é‡‡æ ·é—´éš”è¶Šå° â†’ æ•°æ®è¶Šç²¾ç¡® â†’ åˆ†æå¼€é”€è¶Šå¤§ â†’ ç¨‹åºè¶Šæ…¢
```

---

# ç¬¬äº”éƒ¨åˆ†ï¼šè¿è¡Œæ€§èƒ½åˆ†æ

## 5.1 å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥éª¤ 1ï¼šè¿›å…¥è„šæœ¬ç›®å½•

```bash
cd E:\GitSource\py_fastapi_template\scripts\scalene
```

### æ­¥éª¤ 2ï¼šè¿è¡Œåˆ†æç¨‹åº

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ uvï¼ˆæ¨èï¼‰
uv run -m scalene run --outfile profile_report.json profile_api.py

# æ–¹å¼äºŒï¼šç›´æ¥ä½¿ç”¨ scalene
scalene run --outfile profile_report.json profile_api.py
```

å¯åŠ¨åçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
ğŸš€ å¯åŠ¨æ€§èƒ½åˆ†ææ¨¡å¼
ğŸ“ æœåŠ¡åœ°å€: http://0.0.0.0:8000
ğŸ“Š åˆ†ææ•°æ®å°†ä¿å­˜åˆ°: profile_report.json
ğŸ”§ å·¥ä½œè¿›ç¨‹: 1
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### æ­¥éª¤ 3ï¼šå‘é€æµ‹è¯•è¯·æ±‚

æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œå‘é€è¯·æ±‚ï¼š

```bash
# æµ‹è¯• CPU å¯†é›†å‹æ¥å£
curl http://localhost:8000/test/cpu
curl http://localhost:8000/test/cpu
curl http://localhost:8000/test/cpu

# æµ‹è¯• IO å¯†é›†å‹æ¥å£
curl http://localhost:8000/test/io
curl http://localhost:8000/test/io

# æµ‹è¯•å†…å­˜åˆ†é…æ¥å£
curl http://localhost:8000/test/memory
curl http://localhost:8000/test/memory

# æµ‹è¯•å¤åˆæ¥å£
curl http://localhost:8000/test/complex
```

### æ­¥éª¤ 4ï¼šåœæ­¢åˆ†æ

å›åˆ°æ­¥éª¤ 2 çš„ç»ˆç«¯ï¼ŒæŒ‰ `Ctrl+C` åœæ­¢æœåŠ¡ã€‚

### æ­¥éª¤ 5ï¼šæŸ¥çœ‹åˆ†æç»“æœ

```bash
# æ–¹å¼ä¸€ï¼šåœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ï¼ˆäº¤äº’å¼ç•Œé¢ï¼‰
scalene view profile_report.json

# æ–¹å¼äºŒï¼šç”Ÿæˆ HTML æŠ¥å‘Š
scalene view --html profile_report.json

# æ–¹å¼ä¸‰ï¼šåœ¨ç»ˆç«¯æ˜¾ç¤º
scalene view --cli profile_report.json
```

ç”Ÿæˆçš„ HTML æŠ¥å‘Šä½ç½®ï¼š`E:\GitSource\py_fastapi_template\scripts\scalene\profile_report.html`

## 5.2 å¸¸ç”¨å‘½ä»¤ç»„åˆ

### ç»„åˆ 1ï¼šåŸºç¡€åˆ†æ

```bash
uv run -m scalene run --outfile profile_report.json profile_api.py
# ... å‘é€æµ‹è¯•è¯·æ±‚ ...
# ... æŒ‰ Ctrl+C åœæ­¢ ...
uv run -m scalene view --html profile_report.json
start profile_report.html
```

### ç»„åˆ 2ï¼šå†…å­˜ä¸“é¡¹åˆ†æ

## 5.3 ä¼ é€’å‚æ•°ç»™è„šæœ¬

å¦‚æœéœ€è¦ç»™è„šæœ¬ä¼ é€’å‚æ•°ï¼Œä½¿ç”¨ `---` åˆ†éš”ï¼š

```bash
uv run -m scalene run --outfile profile_report.json profile_api.py --- --port 8080 --host 127.0.0.1
```

---

# ç¬¬å…­éƒ¨åˆ†ï¼šè§£è¯»åˆ†æç»“æœ

## 6.1 æµè§ˆå™¨ç•Œé¢ç»“æ„

æ‰“å¼€ `profile_report.html` æˆ–è¿è¡Œ `scalene view`ï¼Œä½ ä¼šçœ‹åˆ°äº¤äº’å¼ç•Œé¢ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scalene Performance Report                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Overall Summaryï¼ˆæ€»ä½“æ‘˜è¦ï¼‰                      â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚  Total Runtime: 45.2s                           â”‚    â”‚
â”‚  â”‚  Memory Usage: 48.2 MB â†’ 52.1 MB               â”‚    â”‚
â”‚  â”‚  CPU Time: 12.3s                                â”‚    â”‚
â”‚  â”‚  Peak Memory: 128 MB                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Function Profileï¼ˆå‡½æ•°åˆ†æï¼‰                     â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚  Function      â”‚ CPU% â”‚ Memory â”‚ Leaks â”‚ Calls â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚
â”‚  â”‚  test_cpu      â”‚ 35.2 â”‚ 0.0    â”‚ 0     â”‚ 3     â”‚    â”‚
â”‚  â”‚  test_io       â”‚  8.1 â”‚ 0.0    â”‚ 0     â”‚ 2     â”‚    â”‚
â”‚  â”‚  test_memory   â”‚  5.3 â”‚ 12.4   â”‚ 0     â”‚ 2     â”‚    â”‚
â”‚  â”‚  ...           â”‚ ...  â”‚ ...    â”‚ ...   â”‚ ...   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AI Optimization Suggestions âš¡                   â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚  ç‚¹å‡» âš¡ å›¾æ ‡è·å– AI ä¼˜åŒ–å»ºè®®                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6.2 å…³é”®æŒ‡æ ‡è§£è¯»

### 6.2.1 CPU % åˆ—

**å«ä¹‰**ï¼šè¯¥å‡½æ•°æ¶ˆè€—çš„ CPU æ—¶é—´å æ€» CPU æ—¶é—´çš„ç™¾åˆ†æ¯”

**è§£è¯»**ï¼š

| CPU % å€¼  | å«ä¹‰              | å»ºè®®             |
| --------- | ----------------- | ---------------- |
| > 50%     | éå¸¸é«˜çš„ CPU å ç”¨ | **é‡ç‚¹ä¼˜åŒ–å¯¹è±¡** |
| 20% - 50% | é«˜ CPU å ç”¨       | è€ƒè™‘ä¼˜åŒ–         |
| 5% - 20%  | ä¸­ç­‰ CPU å ç”¨     | è§†æƒ…å†µä¼˜åŒ–       |
| < 5%      | ä½ CPU å ç”¨       | é€šå¸¸ä¸éœ€è¦ä¼˜åŒ–   |

### 6.2.2 Memory åˆ—

**å«ä¹‰**ï¼šè¯¥å‡½æ•°åˆ†é…çš„å†…å­˜é‡ï¼ˆMBï¼‰

**è§£è¯»**ï¼š

| Memory å€¼ | å«ä¹‰           | å»ºè®®                       |
| --------- | -------------- | -------------------------- |
| æŒç»­å¢é•¿  | å¯èƒ½çš„å†…å­˜æ³„æ¼ | æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è±¡æœªè¢«é‡Šæ”¾     |
| é«˜å³°å€¼    | å†…å­˜ä½¿ç”¨å¤§æˆ·   | è€ƒè™‘åˆ†æ‰¹å¤„ç†æˆ–ä¼˜åŒ–æ•°æ®ç»“æ„ |
| ç¨³å®š      | å†…å­˜ä½¿ç”¨æ­£å¸¸   | æ— éœ€æ‹…å¿ƒ                   |

### 6.2.3 Leaks åˆ—

**å«ä¹‰**ï¼šæ£€æµ‹åˆ°çš„å†…å­˜æ³„æ¼é‡

**è§£è¯»**ï¼š

| Leaks å€¼ | å«ä¹‰                   |
| -------- | ---------------------- |
| 0        | æœªæ£€æµ‹åˆ°æ³„æ¼           |
| > 0      | å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œéœ€è¦æ’æŸ¥ |

### 6.2.4 Calls åˆ—

**å«ä¹‰**ï¼šå‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°

**è§£è¯»**ï¼š

| Calls å€¼ | å«ä¹‰                     |
| -------- | ------------------------ |
| éå¸¸é«˜   | å‡½æ•°è¢«é¢‘ç¹è°ƒç”¨ï¼Œè€ƒè™‘ä¼˜åŒ– |
| é€‚ä¸­     | æ­£å¸¸è°ƒç”¨é¢‘ç‡             |
| å¾ˆä½     | å‡½æ•°å¾ˆå°‘è¢«æ‰§è¡Œ           |

## 6.3 AI ä¼˜åŒ–å»ºè®®

Scalene 2.0 é›†æˆäº† AI ä¼˜åŒ–å»ºè®®åŠŸèƒ½ï¼š

```
1. åœ¨æŠ¥å‘Šé¡µé¢ï¼Œæ‰¾åˆ°éœ€è¦ä¼˜åŒ–çš„å‡½æ•°æˆ–ä»£ç è¡Œ
2. ç‚¹å‡»æ—è¾¹çš„ âš¡ å›¾æ ‡
3. ç­‰å¾… AI ç”Ÿæˆä¼˜åŒ–å»ºè®®
4. ç‚¹å‡»å»ºè®®å†…å®¹å¯å¤åˆ¶åˆ°å‰ªè´´æ¿
```

**æ”¯æŒçš„ AI æä¾›å•†**ï¼š
- OpenAI GPT-4
- Amazon Bedrock
- Microsoft Azure
- æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰

**é…ç½® AI å»ºè®®**ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# ä½¿ç”¨ OpenAI API
export OPENAI_API_KEY="your-api-key"

# ä½¿ç”¨æœ¬åœ° Ollama
export OLLAMA_MODEL="llama2"
```

## 6.4 è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

### ç“¶é¢ˆç±»å‹ 1ï¼šCPU ç“¶é¢ˆ

**ç‰¹å¾**ï¼š
- CPU % å¾ˆé«˜
- Memory å¾ˆä½æˆ–ç¨³å®š
- ä»£ç ä¸­æœ‰å¤§é‡è®¡ç®—

**ä¼˜åŒ–å»ºè®®**ï¼š
- ä½¿ç”¨æ›´é«˜æ•ˆçš„ç®—æ³•
- è€ƒè™‘ä½¿ç”¨ NumPy/Cython åŠ é€Ÿ
- æ·»åŠ ç¼“å­˜æœºåˆ¶

### ç“¶é¢ˆç±»å‹ 2ï¼šå†…å­˜ç“¶é¢ˆ

**ç‰¹å¾**ï¼š
- Memory å¾ˆé«˜
- Leaks > 0
- å†…å­˜æŒç»­å¢é•¿

**ä¼˜åŒ–å»ºè®®**ï¼š
- ä½¿ç”¨ç”Ÿæˆå™¨æ›¿ä»£åˆ—è¡¨
- åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¯¹è±¡
- è€ƒè™‘ä½¿ç”¨åˆ†æ‰¹å¤„ç†

### ç“¶é¢ˆç±»å‹ 3ï¼šIO ç“¶é¢ˆ

**ç‰¹å¾**ï¼š
- CPU % ä¸é«˜
- ä½†å“åº”æ—¶é—´é•¿
- æ¶‰åŠç½‘ç»œã€ç£ç›˜æ“ä½œ

**ä¼˜åŒ–å»ºè®®**ï¼š
- ä½¿ç”¨å¼‚æ­¥æ“ä½œ
- æ·»åŠ è¿æ¥æ± 
- å®æ–½ç¼“å­˜ç­–ç•¥

## 6.5 ä¼˜åŒ–å‰åå¯¹æ¯”

### ä¼˜åŒ–å‰æµ‹è¯•

```bash
cd E:\GitSource\py_fastapi_template\scripts\scalene
uv run -m scalene run --outfile before_report.json profile_api.py
# å‘é€æµ‹è¯•è¯·æ±‚
for i in {1..10}; do curl http://localhost:8000/test/cpu; done
```

### ä¼˜åŒ–åæµ‹è¯•

```bash
uv run -m scalene run --outfile after_report.json profile_api.py
# å‘é€ç›¸åŒæ•°é‡çš„è¯·æ±‚
for i in {1..10}; do curl http://localhost:8000/test/cpu; done
```

### æœŸæœ›ç»“æœ

```
æŒ‡æ ‡                 â”‚ ä¼˜åŒ–å‰   â”‚ ä¼˜åŒ–å   â”‚ æå‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€
CPU % (ç›®æ ‡å‡½æ•°)     â”‚ 72.3%   â”‚ 35.1%   â”‚ 51%
æ‰§è¡Œæ—¶é—´             â”‚ 1200ms  â”‚ 450ms   â”‚ 62.5%
å†…å­˜ä½¿ç”¨å³°å€¼         â”‚ 256MB   â”‚ 128MB   â”‚ 50%
```

---

# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®é™…ä½¿ç”¨æ¡ˆä¾‹

## 7.1 åˆ›å»ºæµ‹è¯•è·¯ç”±

> **æ³¨æ„**ï¼šæµ‹è¯•è·¯ç”±éœ€è¦æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œè¯·å‚è€ƒé¡¹ç›®å®é™…ç»“æ„ã€‚

å»ºè®®åœ¨ `app/api/routes/v1/` ç›®å½•ä¸‹åˆ›å»º `profile_test.py`ï¼š

```python
"""
æ€§èƒ½æµ‹è¯•è·¯ç”±

æä¾›ä¸åŒç±»å‹çš„æµ‹è¯•æ¥å£ï¼š
- /test/cpu: CPU å¯†é›†å‹ä»»åŠ¡
- /test/io: IO å¯†é›†å‹ä»»åŠ¡  
- /test/memory: å†…å­˜åˆ†é…ä»»åŠ¡
- /test/complex: å¤åˆä»»åŠ¡
"""

from fastapi import APIRouter
import time
import asyncio
import random

router = APIRouter()


@router.get("/test/cpu")
def test_cpu_bound():
    """
    CPU å¯†é›†å‹æµ‹è¯•
    
    è¿™ä¸ªæ¥å£ä¼šè¿›è¡Œå¤§é‡è®¡ç®—ï¼Œæ¶ˆè€— CPU èµ„æº
    """
    start_time = time.time()
    
    result = 0
    for i in range(100000):
        result += i * i
    
    end_time = time.time()
    
    return {
        "type": "CPU å¯†é›†å‹",
        "result": result,
        "time_ms": round((end_time - start_time) * 1000, 2)
    }


@router.get("/test/io")
async def test_io_bound():
    """
    IO å¯†é›†å‹æµ‹è¯•ï¼ˆå¼‚æ­¥ï¼‰
    """
    start_time = time.time()
    await asyncio.sleep(0.1)
    end_time = time.time()
    
    return {
        "type": "IO å¯†é›†å‹ï¼ˆå¼‚æ­¥ï¼‰",
        "sleep_ms": 100,
        "time_ms": round((end_time - start_time) * 1000, 2)
    }


@router.get("/test/memory")
def test_memory():
    """
    å†…å­˜åˆ†é…æµ‹è¯•
    """
    data = [random.randint(0, 1000) for _ in range(10000)]
    
    return {
        "type": "å†…å­˜åˆ†é…",
        "list_length": len(data),
        "approximate_size_kb": len(data) * 28 / 1024
    }


@router.get("/test/complex")
async def test_complex():
    """
    å¤åˆæµ‹è¯•
    """
    start = time.time()
    data = [i * 2 for i in range(5000)]
    compute_time = time.time() - start
    
    await asyncio.sleep(0.05)
    
    processed = [x ** 2 for x in data]
    
    return {
        "type": "å¤åˆæ“ä½œ",
        "compute_time_ms": round(compute_time * 1000, 2),
        "io_time_ms": 50,
        "memory_items": len(processed)
    }
```

## 7.2 æ³¨å†Œæµ‹è¯•è·¯ç”±

åœ¨ `app/api/main.py` ä¸­æ·»åŠ ï¼š

```python
from app.api.routes.v1 import login, users, redis_example
from app.api.routes.v1 import profile_test

api_router = APIRouter()

api_router.include_router(login.router)
api_router.include_router(users.router)
api_router.include_router(redis_example.router)
api_router.include_router(profile_test.router)
```

## 7.3 å®Œæ•´çš„æµ‹è¯•æ¸…å•

```
â–¡ 1. ç¡®ä¿å·²å®‰è£… Scalene
   â””â”€ pip install -U scalene

â–¡ 2. è¿›å…¥è„šæœ¬ç›®å½•
   â””â”€ cd E:\GitSource\py_fastapi_template\scripts\scalene

â–¡ 3. å¯åŠ¨åˆ†æ
   â””â”€ uv run -m scalene run --outfile profile_report.json profile_api.py

â–¡ 4. å‘é€æµ‹è¯•è¯·æ±‚ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
   â””â”€ curl http://localhost:8000/test/cpu (10æ¬¡)
   â””â”€ curl http://localhost:8000/test/memory (5æ¬¡)
   â””â”€ curl http://localhost:8000/test/io (5æ¬¡)
   â””â”€ curl http://localhost:8000/test/complex (3æ¬¡)

â–¡ 5. åœæ­¢åˆ†æ (Ctrl+C)

â–¡ 6. ç”Ÿæˆå¹¶æŸ¥çœ‹æŠ¥å‘Š
   â””â”€ uv run -m scalene view --html profile_report.json
   â””â”€ start profile_report.html

â–¡ 7. åˆ†æç»“æœå¹¶ä¼˜åŒ–

â–¡ 8. é‡æ–°æµ‹è¯•å¯¹æ¯”
```

---

# ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜

## Q1ï¼šScalene 2.0 å‘½ä»¤æ ¼å¼å˜åŒ–ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæ˜¯çš„ï¼ŒScalene 2.0 é‡‡ç”¨äº†æ–°çš„å‘½ä»¤ç»“æ„ã€‚

```bash
# âŒ æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆ1.xï¼‰
scalene --html script.py

# âœ… æ–°ç‰ˆæœ¬æ ¼å¼ï¼ˆ2.0+ï¼‰
scalene run --outfile report.json script.py    # åˆ†æç¨‹åº
scalene view --html report.json                # ç”ŸæˆæŠ¥å‘Š
```

## Q2ï¼šä¸ºä»€ä¹ˆåªç”Ÿæˆäº† JSON æ–‡ä»¶ï¼Ÿ

**åŸå› **ï¼šåœ¨ Scalene 2.0 ä¸­ï¼Œ`run` å‘½ä»¤åªç”Ÿæˆ JSON åŸå§‹æ•°æ®ã€‚

**è§£å†³**ï¼š

```bash
# æ­¥éª¤ 1ï¼šè¿è¡Œåˆ†æ
scalene run --outfile report.json script.py

# æ­¥éª¤ 2ï¼šç”Ÿæˆ HTML æŠ¥å‘Š
scalene view --html report.json

# æˆ–è€…ç›´æ¥åœ¨æµè§ˆå™¨æŸ¥çœ‹
scalene view report.json
```

## Q3ï¼šScalene æ”¯æŒ Windows å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæ”¯æŒã€‚

```
âœ“ Windows åŸç”Ÿ      â†’ å®Œå…¨æ”¯æŒ
âœ— WSL (Linux å­ç³»ç»Ÿ) â†’ éƒ¨åˆ†åŠŸèƒ½å—é™
```

## Q4ï¼šåˆ†ææ—¶ç¨‹åºå˜æ…¢äº†ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæ­£å¸¸çš„ï¼Œé‡‡æ ·åˆ†æä¼šæœ‰å¼€é”€ã€‚

**å‡å°‘å¼€é”€çš„æ–¹æ³•**ï¼š

```bash
# æ–¹æ³• 1ï¼šå¢å¤§é‡‡æ ·é—´éš”
scalene run --cpu-sampling-rate 0.01 --outfile report.json script.py

# æ–¹æ³• 2ï¼šåªåˆ†æç‰¹å®šæ¨¡å—
scalene run --profile-only "app.api" --outfile report.json script.py

# æ–¹æ³• 3ï¼šåªåˆ†æ CPU
scalene run --cpu-only --outfile report.json script.py
```

**å¼€é”€å‚è€ƒ**ï¼š

| é‡‡æ ·é—´éš” | å¼€é”€ | ç²¾ç¡®åº¦ |
| -------- | ---- | ------ |
| 0.0001   | ~50% | æœ€é«˜   |
| 0.001    | ~10% | é«˜     |
| 0.01     | ~5%  | ä¸­ç­‰   |
| 0.1      | ~1%  | ä½     |

## Q5ï¼šæŠ¥å‘Šæ˜¯ç©ºçš„ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š

1. **ç¨‹åºè¿è¡Œæ—¶é—´å¤ªçŸ­**
   - å»ºè®®è¿è¡Œè‡³å°‘ 10 ç§’
   - å¢åŠ æµ‹è¯•è¯·æ±‚æ¬¡æ•°

2. **é‡‡æ ·é—´éš”å¤ªå¤§**
   - å‡å°é‡‡æ ·é—´éš”

3. **è¢«åˆ†æçš„å‡½æ•°æ²¡æœ‰æ‰§è¡Œ**
   - ç¡®ä¿æµ‹è¯•æ¥å£è¢«è°ƒç”¨

## Q6ï¼šå¤šè¿›ç¨‹æ¨¡å¼ä¸‹å¦‚ä½•åˆ†æï¼Ÿ

**é—®é¢˜**ï¼šuWSGI/Gunicorn å¤šè¿›ç¨‹æ—¶ï¼ŒScalene åªèƒ½åˆ†æä¸»è¿›ç¨‹

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ¡ˆ 1ï¼šåªç”¨å•è¿›ç¨‹ï¼ˆå¼€å‘ç¯å¢ƒæ¨èï¼‰
scalene run --outfile report.json profile_api.py --workers 1

# æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ --profile-children
scalene run --profile-children --outfile report.json profile_api.py
```

## Q7ï¼šå¦‚ä½•åˆ†æå¼‚æ­¥ä»£ç ï¼Ÿ

**ç­”æ¡ˆ**ï¼šScalene å¯ä»¥åˆ†æå¼‚æ­¥ä»£ç ã€‚

```bash
# æ­£å¸¸è¿è¡Œå³å¯
scalene run --outfile report.json profile_api.py
```

## Q8ï¼šå¦‚ä½•é…ç½® AI ä¼˜åŒ–å»ºè®®ï¼Ÿ

**æ­¥éª¤**ï¼š

```bash
# è®¾ç½® API Keyï¼ˆæ ¹æ®ä½ çš„ AI æä¾›å•†ï¼‰
export OPENAI_API_KEY="your-api-key"

# æˆ–è€…ä½¿ç”¨ Ollama æœ¬åœ°æ¨¡å‹
export OLLAMA_MODEL="llama2"

# è¿è¡Œåˆ†æ
scalene run --outfile report.json profile_api.py

# æŸ¥çœ‹æŠ¥å‘Šæ—¶ï¼Œç‚¹å‡» âš¡ å›¾æ ‡è·å–å»ºè®®
```

## Q9ï¼šåˆ†ææŠ¥å‘Šç”Ÿæˆåœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆ**ï¼šé»˜è®¤ç”Ÿæˆåœ¨å½“å‰å·¥ä½œç›®å½•ã€‚

```
ç”Ÿæˆä½ç½®ï¼šE:\GitSource\py_fastapi_template\scripts\scalene\profile_report.json
HTML æŠ¥å‘Šï¼šE:\GitSource\py_fastapi_template\scripts\scalene\profile_report.html
```

## Q10ï¼šå¦‚ä½•ä¼ é€’ç»™è„šæœ¬å‚æ•°ï¼Ÿ

**ä½¿ç”¨ `---` åˆ†éš”**ï¼š

```bash
scalene run --outfile report.json profile_api.py --- --port 8080 --host 127.0.0.1
```

---

# é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

## run å‘½ä»¤

| ç›®çš„           | å‘½ä»¤                                                                          |
| -------------- | ----------------------------------------------------------------------------- |
| åŸºç¡€åˆ†æ       | `scalene run --outfile report.json profile_api.py`                            |
| å†…å­˜åˆ†æ       | `scalene run --memory --outfile report.json profile_api.py`                   |
| é«˜ç²¾åº¦é‡‡æ ·     | `scalene run --cpu-sampling-rate 0.0001 --outfile report.json profile_api.py` |
| åªåˆ†æ CPU     | `scalene run --cpu-only --outfile report.json profile_api.py`                 |
| åˆ†æå­è¿›ç¨‹     | `scalene run --profile-children --outfile report.json profile_api.py`         |
| åªåˆ†æç‰¹å®šæ¨¡å— | `scalene run --profile-only "app.api" --outfile report.json profile_api.py`   |
| æ’é™¤ç‰¹å®šæ¨¡å—   | `scalene run --profile-exclude "tests" --outfile report.json profile_api.py`  |
| ä¼ é€’è„šæœ¬å‚æ•°   | `scalene run --outfile report.json profile_api.py --- --port 8080`            |

## view å‘½ä»¤

| ç›®çš„       | å‘½ä»¤                              |
| ---------- | --------------------------------- |
| æµè§ˆå™¨æŸ¥çœ‹ | `scalene view report.json`        |
| ç”Ÿæˆ HTML  | `scalene view --html report.json` |
| ç»ˆç«¯æŸ¥çœ‹   | `scalene view --cli report.json`  |

## uv å‘½ä»¤

| ç›®çš„      | å‘½ä»¤                                                         |
| --------- | ------------------------------------------------------------ |
| è¿è¡Œåˆ†æ  | `uv run -m scalene run --outfile report.json profile_api.py` |
| ç”Ÿæˆ HTML | `uv run -m scalene view --html report.json`                  |
| æŸ¥çœ‹å¸®åŠ©  | `uv run -m scalene --help`                                   |

---

# æ€»ç»“

é€šè¿‡è¿™ä»½æŒ‡å—ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

1. **ç†è§£** æ€§èƒ½åˆ†æçš„æ¦‚å¿µå’Œé‡è¦æ€§
2. **è®¤è¯†** Scalene å·¥å…·çš„åŠŸèƒ½å’ŒåŸç†
3. **å®‰è£…** Scalene å¹¶éªŒè¯å®‰è£…æˆåŠŸ
4. **ä½¿ç”¨** Scalene 2.0 çš„æ–°å‘½ä»¤ç»“æ„ï¼ˆrun + viewï¼‰
5. **ä½¿ç”¨** scripts/scalene ç›®å½•ä¸‹çš„è„šæœ¬è¿›è¡Œæ€§èƒ½åˆ†æ
6. **è§£è¯»** åˆ†æç»“æœï¼Œè¯†åˆ«ç“¶é¢ˆ
7. **åˆ©ç”¨** AI ä¼˜åŒ–å»ºè®®åŠŸèƒ½
8. **ä¼˜åŒ–** ä»£ç å¹¶éªŒè¯æ•ˆæœ

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼š

1. åŠ¨æ‰‹è¿è¡Œä¸€éç¤ºä¾‹æµç¨‹
2. ç”¨ä½ çš„å®é™…ä¸šåŠ¡æ¥å£è¿›è¡Œæµ‹è¯•
3. æ ¹æ®æŠ¥å‘Šä¼˜åŒ–ä»£ç 
4. å°è¯• AI ä¼˜åŒ–å»ºè®®åŠŸèƒ½
5. å»ºç«‹æ€§èƒ½åŸºå‡†ï¼Œå®šæœŸå›å½’æµ‹è¯•

**æ–‡ä»¶ä½ç½®æ€»ç»“**ï¼š

```
E:\GitSource\py_fastapi_template\
â””â”€â”€ scripts\
    â””â”€â”€ scalene\                    â† æ‰€æœ‰ Scalene ç›¸å…³æ–‡ä»¶
        â”œâ”€â”€ profile_api.py          â† åŸºç¡€åˆ†æè„šæœ¬
        â”œâ”€â”€ profile_api_advanced.py â† é«˜çº§åˆ†æè„šæœ¬
        â”œâ”€â”€ Makefile                â† å¸¸ç”¨å‘½ä»¤
        â””â”€â”€ README.md               â† æœ¬æ–‡æ¡£
```

**é‡è¦æç¤º**ï¼š

```
Scalene 2.0 ä½¿ç”¨æ–°çš„å‘½ä»¤ç»“æ„ï¼š
1. å…ˆè¿è¡Œ: scalene run --outfile report.json script.py
2. å†æŸ¥çœ‹: scalene view --html report.json
```

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œéšæ—¶è¯¢é—®ã€‚

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2026å¹´1æœˆ*
*åŸºäº Scalene 2.0+ ç‰ˆæœ¬ç¼–å†™*
